/*!
 * via JavaScript Library 0.1pre
 * http://semanticsworks.com/p/viaproxy.html
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Thu Nov 24 23:01:51 2011 -0500
 */
 window.jQuery&&window.via||function(g,Z,l){function B(c){this.context=p(c||"",!0)}function v(c){return"object"===typeof c}function m(c){return"string"===typeof c}function F(c){return null===c||typeof c in qa}function P(c){return c===l}function x(c,a){0===a&&(a="0");var b,d,e=C,h=f.joinPath(c,a),g=p(h,!0),j=g.split(".");if(1===j.length)d=g;else{d=j[j.length-1];for(b=0;b<j.length-1&&!(e=e[j[b]],e===l);b++);}if(F(e))throw"invalid access proxy using path:"+h;return{physicalPath:g,logicalPath:h,hostObj:e,
index:d}}function G(c){this.mainPath=c}function p(c,a){if(!c)return"";if("*"===c)return i;var b=c.split("*");if(1===b.length)return c;var d=b[0],b=b[1],e=d.replace($,"_");if(a&&d){var h=i+"."+e;!ra[e]&&n.get(d)!==l&&n.create(h,new G(d))}return!e?i+"."+b:b?i+"."+e+"."+b:i+"."+e}function aa(c){if(c===i)return"*";var a=sa.exec(c);return a&&a[1]?a[2]?a[1].replace(Q,".")+"*"+a[3]:a[1].replace(Q,".")+"*":c}function H(c,a,b,d){var e,h=c.lastIndexOf(".");b&&(-1===h?(b="",e=c):(b=c.substring(0,h),e=c.substring(h+
1)),d(b,e,a));if(!F(a))for(e in a)y.call(a,e)&&(d(c,e,a[e]),H(c+"."+e,a[e],!1,d))}function ba(c,a,b){if(o(b))for(var b=b.toString(),d,e,h,f;(d=ta.exec(b))&&(e=d[1]);)c?(h=c+"."+a,f=c+"."+e):(h=a,f=e),k[f]=k[f]||[],k[f].pushUnique(h)}function ua(c,a){n.del(c+"."+a)}function ca(c){var a,b,d=q[c.path];if(d)for(b=0;b<d.length;b++){a=d[b];if(da(a.modelEvents,c.eventType))c.options=a.options,R(a.view,a.modelHandler,c);if(!c.continueEventing)break}if((a=k[c.path])&&a.length)for(d=0;d<a.length;d++){b=r(a[d],
a[d],c.eventType,c.proposed===l?l:n.get(!0,a[d]));if(!b.continueEventing)break;if(b.hasError)c.hasError=!0}}function R(c,a,b){c===S&&(c=null);if(o(a))return a.call(c,b);if(m(a)){var d=a.substring(1),e=a.substring(2);if(0===a.indexOf("*")){if(d=I[d])return d.call(c,b)}else if(0===a.indexOf("$")){if(o(z[d])){a=b.currentValue();if(-1!="css,attr,prop".indexOf(d))b=b.options||b.targetIndex(),g(c)[d](b,a);else g(c)[d](a&&a.toString());return}}else if(0===a.indexOf("v.")&&c[e]){a=b.currentValue();if(o(c[e]))c[e](a);
else c[e]=a;return}}throw"handler: "+a+" not found";}function da(c,a){var b;if("*"===c)return!0;for(var c=c.split(ea),d=0;d<c.length;d++){b=c[d];if(b===a)return!0;if(b=va.exec(b))if(b[4])if(b[1]){if(T("^"+b[1]+"\\w*\\."+b[4]).test(a))return!0}else{if(T("^\\w+\\."+b[4]).test(a))return!0}else if(b[3]){if(b=b[1]?T("^"+b[1]+"(?!\\w*\\.\\w+)"):wa,b.test(a))return!0}else if(0===a.indexOf(b[1]))return!0}return!1}function A(c,a,b,d,e){v(c)?t(this,c):(this.path=c,this.target=a,this.eventType=b,!P(d)&&(this.proposed=
d),!P(e)&&(this.removed=e))}function fa(c,a){m(c)&&0===c.indexOf("*")&&(c=I[c.substring(1)]);o(c.buildOptions)&&(a=c.buildOptions(a));return a}function U(c){g(c).data(i,!0)}function J(c){return!0===g(c).data(i)}function K(c,a,b,d){v(c)?t(this,c):(this.path=c,this.options=a,this.e=b,this.triggerData=d)}function xa(c,a){var b=c.data,d=new K(b.path,b.options,c,a),b=b.viewHandler;if(o(b))return L(d,b.call(this,d));if(m(b)){var e=b.substring(1),h=b.substring(2);if(0===b.indexOf("*")){if(e=V[e]){e.call(this,
d);return}}else if(0===b.indexOf("$")){if(o(z[e]))return L(d,-1!="css,attr,prop".indexOf(e)?g(this)[e](d.options||d.targetIndex()):g(this)[e]())}else if(0===b.indexOf("p.")){if(o(W[h])){d.targetProxy()[h](d);return}}else if(0===b.indexOf("v.")){if(e=this[h],o(e))return L(d,e.call(this,d))}else if(0===b.indexOf("m.")&&(e=n.get(!0,h),o(e)))return L(d,e.call(this,d))}throw"view handler: '"+b+"' not found";}function L(c,a){if(a!==l){var b=c.options;m(b)&&0===b.indexOf("*")&&(b=ga[b.substring(1)])&&(a=
b(a));n.update(c.path,a)}}function ha(c){if(!m(c))throw"bindingText must non-empty string";for(var a={},b,d;b=ya.exec(c);)d=b[1],b=b[3]&&g.trim(b[3])||!0,a[d]=a[d]?a[d]+";"+b:b;return a}function za(c){if(!c)return!1;var a;a:{a=c+".";for(var b in D)if(0===b.indexOf(a)){a=!0;break a}a=!1}if(a)return!0;a=ia(c);if(!a)return!1;b=0;for(var d;d=a[b];b++)for(var e in d){var h=d[e],f=c+"."+e;D[f]=D[f]?D[f]+h:h}return!0}function ia(c){var a=f.themes[c];if(a){c=[];a.bindingSet&&c.push(a.bindingSet);if(a=a.subThemes)for(var a=
a.split(";"),b=0;b<a.length;b++)c=c.concat(ia(a[b]));return c}}function ja(c,a,b){if(a[E]&&"_"!==a[E]&&za(a.theme))for(var d=a[E].split(Aa),e,h=0;h<d.length;h++){var f=Ba.exec(d[h]);if(e=D[a.theme+"."+f[1]]){e=ha(e);e.path=ka(a.path,f[3]);e.theme=a.theme;e.options=f[5]||a.options;ja(c,e,b);var f=c,g=e,i=b;M("mh",f,g,i);M("vh",f,g,i);la(c,e,b)}}}function ma(c){for(c=g(c);(c=c.parent())&&c.length;){var a=c.data("via");if(a&&a.path)return a.path}return""}function ka(c,a){if(!a||"."==a)return c;if(na.test(a))return a.replace(na,
f.contextOfPath(c)+"$1");if(X.test(a)){var b=/^(.+)\*/.exec(c);return b&&b[1]&&0===a.indexOf("*")?b[1]+a:a.replace(X,c+"$&")}return a}function M(c,a,b,d){var e,f,g,j;if(j=b[c]&&b[c].replace(Ca,"").split(";"))for(e=0;e<j.length;e++)if(f=Da.exec(j[e]))g=ka(b.path,f[1]),d[c].push("mh"===c?{path:g,modelEvents:f[2],view:a,modelHandler:f[3],options:f[5]||b.options}:{path:g,viewEvents:f[2],view:a,viewHandler:f[3],options:f[5]||b.options})}function la(c,a,b){var d,e;for(e in a)y.call(a,e)&&!Ea.contains(e)&&
(d=f.specialParsers[e])&&d(c,a,b,a[e])}function Y(c){var a=c.currentValue(),c=c.options;c.get=function(a){return n.get(a)};a&&(N(a)&&a.length||!N(a))?(a=f.renderTemplate(c.templateId,a,c),g(this).html(a),a.findAll(":via").parseView()):g(this).empty()}function oa(c){var a=c.currentValue();c.currentValue=function(){return[a]};Y.call(this,c)}var f=Z.via=function(c){return new B(c)},t=g.extend,C={},N=g.isArray,Fa=g.isPlainObject,o=g.isFunction,ta=/this\.((?:\.?\w+)+)/g,qa={undefined:l,"boolean":l,number:l,
string:l},i="__via",Ga=/__via\.(\w+)/,sa=/__via\.(\w+)(\.(.+))*/,k={},u={},n,ra=C[i]={},Q=/_/g,$=/\./g,y=C.hasOwnProperty,w=Array.prototype,Ha=w.slice,r,W=B.prototype={};w.indexOf=w.indexOf||function(c,a){for(var b=a||0;b<this.length;b++)if(this[b]==c)return b;return-1};w.contains=w.contains||function(c){return-1!==this.indexOf(c)};w.remove=w.remove||function(c){c=this.indexOf(c);-1!=c&&this.splice(c,1);return this};w.pushUnique=w.pushUnique||function(c){-1===this.indexOf(c)&&this.push(c);return this};
t(W,{version:"0.1pre",constructor:B,pushProxy:function(c){c.oldProxy=this;return c},childProxy:function(c){return this.pushProxy(new B(f.joinPath(this.context,c)))},parentProxy:function(){return this.pushProxy(new f(f.contextOfPath(this.context)))},popProxy:function(){if(this.oldProxy)return this.oldProxy;throw"invalid operation, proxy.popProxy() failed because oldProxy is empty";},shadowProxy:function(){return this.childProxy("*")},mainProxy:function(){var c;if(this.context===i)c="";else if((c=
Ga.exec(this.context))&&c[1])c=c[1].replace(Q,".");else throw"proxy at '"+this.context+"' is already main proxy";return this.pushProxy(f(c))},triggerChange:function(c){c=this.physicalPath(c);r(c,c,"afterUpdate");return this},logicalPath:function(c){return aa(f.joinPath(this.context,c))},physicalPath:function(c){return p(f.joinPath(this.context,c))},get:function(c,a){if(m(c)||"number"===typeof c)a=""+c,c=!1;var b=x(this.context,a),d=!b.index?b.hostObj:b.hostObj[b.index];return!c&&o(d)?d.call(b.hostObj):
d},call:function(c){var a=x(this.context,c),b=a.hostObj[a.index];if(!o(b))throw"object at '"+a.logicalPath+"' is not a function";return b.apply(a.hostObj,Ha.call(arguments,1))},create:function(c,a,b){if(Fa(c)){for(var d in c)if(y.call(c,d)&&(b=this.create(d,c[d],a),!b))return!1;return this}b=b||x(this.context,c);if(b.index in b.hostObj)throw"value at path: '"+b.logicalPath+"' has been defined, try use update method instead";c=b.physicalPath;if(r(c,c,"beforeCreate",a).hasError)return!1;b.hostObj[b.index]=
a;r(c,c,"afterCreate");H(c,a,!0,ba);return this},update:function(c,a,b){if(""!==this.context&&1===arguments.length)return n.update(this.context,c);b=b||x(this.context,c);if(!(b.index in b.hostObj))throw"value at path: '"+b.logicalPath+"' has been not defined, try use create method instead";var d=b.physicalPath;if(r(d,d,"beforeUpdate",a).hasError)return!1;var e=b.hostObj[b.index];if(e===a)return this;b.hostObj[b.index]=a;r(d,d,"afterUpdate",l,e);H(d,a,!0,ba);return this},del:function(c,a){if(c===l)return n.del(this.context);
var b=x(this.context,c);if(!a&&k[c]&&k[c].length)throw"can not remove path "+c+", because it is referenced!";var d=b.physicalPath;if(!a&&r(d,d,"beforeDel").hasError)return!1;var e=b.hostObj[b.index];H(d,e,!1,ua);N(b.hostObj)?b.hostObj.splice(b.index,1):delete b.hostObj[b.index];r(d,d,"afterDel",l,e);for(b=0;b<f.modelCleanups.length;b++)f.modelCleanups[b](d);return this},createOrUpdate:function(c,a){var b=x(this.context,c);return b.index in b.hostObj?this.update(c,a,b):this.create(c,a,b)},createIfUndefined:function(c,
a){var b=x(this.context,c);return b.index in b.hostObj?this:this.create(c,a,b)},updateAll:function(c){var a,b;for(b in c)if(y.call(c,b)&&(a=this.update(b,c[b]),!a))return!1;return this},isModelEmpty:function(c,a){var b=this.get(c,a);return!b?!0:!N(b)?!1:0===b.length},indexOf:function(c){return this.get().indexOf(c)},contains:function(c){return-1!==this.indexOf(c)},first:function(){return this.get("0")},last:function(){var c=this.get();return c[c.length-1]},push:function(c){return this.create(this.get().length,
c)},pushUnique:function(c){return!this.contains(c)?this.push(c):this},pop:function(){return this.removeAt(this.get().length-1)},insertAt:function(c,a){this.get().splice(c,0,a);r(this.context,this.context+"."+c,"afterCreate");return this},updateAt:function(c,a){return this.update(c,a)},removeAt:function(c){return this.del(c)},prepend:function(c){return this.insertAt(0,c)},swap:function(c,a){if(c==a)return this;var b=this.indexOf(c);if(-1!=b)return this.updateAt(b,a);throw"oldItem not found";},removeItem:function(c){c=
this.indexOf(c);return-1!==c?this.removeAt(c):this},clear:function(){var c=this.get();c.splice(0,c.length);r(this.context,this.context,"init");return this},count:function(){return this.get().length}});G.prototype={constructor:G,mainModel:function(){return n.get(this.mainPath)}};t(f,{fn:W,joinPath:function(c,a){return!a?c:c?c+(0===a.toString().indexOf("*")?a:"."+a):a},accessor:x,physicalPath:p,logicalPath:aa,clearObj:function a(b){if(F(b))return null;for(var d in b)y.call(b,d)&&(b[d]=a(b[d]));return b},
isUndefined:P,isPrimitive:F,isString:m,isObject:v,ns:function(){return i},Shadow:G,modelCleanups:[function(a){for(var b in k)k[b].remove(a),0===k[b].length&&delete k[b];for(var d in k)0===d.indexOf(a)&&delete k[d];0!==a.indexOf(i)&&n.del(i+"."+a.replace($,"_"))}],addRef:function(a,b){a=p(a);b=p(b);k[b]=k[b]||[];k[b].pushUnique(a);return this},removeRef:function(a,b){a=p(a);b=p(b);k[b].remove(a);k[b].length||delete k[b];return this},modelReferences:k,options:function(a,b){if(a===l)return u;if(v(a))return t(u,
a),a;if(1===arguments.length)return u[a];if(b===l)delete u[a];else return u[a]=b},getAll:function(){var a=t({},C);delete a[i];return a},empty:function(){for(var a in C)a!==i&&n.del(a,!0)}});n=new B("");var va=/(\w+)?(\*?)(\.?)([^\s]*)/,Ia=/^(.+)\.\w+$/,Ja=/^.+\.(\w+)$|\w+/,S={},T=Z.RegExp,q={},I={},ea=/\s*\|\s*/,wa=/^\w+(?!\w*\.\w+)/,Ka=/^(\w+)\.?/,z=g.fn;r=function(a,b,d,e,h){a=new A(a,b,d,e,h);ca(a);if(a.continueEventing&&a.bubbleUp)for(a.eventType=Ka.exec(a.eventType)[1]+".child";((b=f.contextOfPath(a.path))||
1)&&!(a.path=b,ca(a),!a.continueEventing||!a.bubbleUp||""===b););return a};A.prototype={constructor:A,targetProxy:function(){return f(this.target)},targetValue:function(a){return f().get(a,this.target)},targetContext:function(){return f.contextOfPath(this.target)},targetIndex:function(){return f.indexOfPath(this.target)},bubbleUp:!0,continueEventing:!0,hasError:!1,currentValue:function(a){return f().get(a,this.path)},currentProxy:function(){return f(this.path)},isModelEmpty:function(){var a=this.options,
a=a?m(a)?"true"===a:!!a:!1;return this.currentProxy().isModelEmpty(a)}};U(S);t(f,{addModelHandler:function(a,b,d,e,h){if("once"===b)return this.renderViews(a,d,e,h);if(m(d)||o(d))h=e,e=d,d=S;"_"===h&&(h=l);a=p(a,!0);d=g(d);0<d.length&&!q[a]&&(q[a]=[]);d.each(function(){h=fa(e,h);U(this);q[a].push({view:this,modelHandler:e,modelEvents:b,options:h});da(b,"init")&&R(this,e,new A({path:a,target:a,eventType:"init",options:h}))});return f},removeModelHandler:function(a){if(m(a)){var a=p(a),b;for(b in q)0===
b.indexOf(a)&&delete q[b]}else v(a)&&g(a).each(function(a,b){if(J(b))for(var f in q){for(var g=q[f],j=g.length-1;0<=j;j--)g[j].view===b&&g.splice(j,1);0===g.length&&delete q[f]}});return f},getModelHandlerData:function(a){if(m(a))return q[p(a)];if(v(a)){if(!J(a))return;var b={},d;for(d in q)for(var e=q[d],f=e.length-1;0<=f;f--)e[f].view===a&&(b[d]=b[d]||[],b[d].push(e[f]));return b}if(!a)return q},renderViews:function(a,b,d,e){a=p(a,!0);g(b).each(function(){e=fa(d,e);R(this,d,new A({path:a,target:a,
eventType:"init",options:e}))});return f},ModelEvent:A,commonModelHandlers:I,raiseEvent:r,indexOfPath:function(a){a=Ja.exec(a);return a[1]||a[0]},contextOfPath:function(a){return(a=Ia.exec(a))&&a[1]||""}});f.modelCleanups.push(f.removeModelHandler);z.addModelHandler=function(a,b,d,e){f.addModelHandler(a,b,this,d,e);return this};z.renderViews=function(a,b,d){f.renderViews(a,this,b,d);return this};var V={},ga={},s={};K.prototype={constructor:K,targetProxy:function(){return f(this.path)},targetValue:function(a){return n.get(a,
this.path)},targetContext:function(){return f.contextOfPath(this.path)},targetIndex:function(){return f.indexOfPath(this.path)},updateModel:function(a){return n.update(this.path,a)},returnFalse:function(){this.e.stopPropagation();this.e.preventDefault()},stopPropagation:function(){this.e.stopPropagation()},stopImmediatePropagation:function(){this.e.stopImmediatePropagation()}};t(f,{addViewHandler:function(a,b,d,e,h){var d=p(d,!0),k=e;"_"===h&&(h=l);m(e)&&0===e.indexOf("*")&&(e=V[e.substring(1)]);
o(e.buildOptions)&&(h=e.buildOptions(a,h));o(e.initialize)&&e.initialize(a);g(a).each(function(){U(this);b=g.map(b.split(ea),function(a){return a+"."+i+"."+d}).toString();g(this).bind(b,{viewHandler:e,path:d,options:h,originalHandler:k},xa);s[d]=s[d]||[];s[d].pushUnique(this)});return f},removeViewHandler:function(a){m(a)?(a=p(a),g(s[a]).unbind("."+i+"."+a),delete s[a]):v(a)&&(g(a).unbind("."+i),g(a).each(function(){for(var a in s)s[a].remove(this)}));return f},removeView:function(a){g(a).each(function(a,
d){J(this)&&(f.removeModelHandler(d).removeViewHandler(d),g(this).removeData(i))});return f},commonViewHandlers:V,valueConverters:ga,ViewEvent:K,getViewHandlerData:function(a){if(m(a))return s[a];if(v(a)){if(!J(a))return;var b=[],d;for(d in s)y.call(s,d)&&s[d].contains(a)&&b.push(d);return b}if(!a)return s},getHandlerData:function(a){var b=f.getModelHandlerData(a),d=f.getViewHandlerData(a);return m(a)?{viewsToBeUpdated:b,viewsUpdatingMe:d}:{modelsUpdatingMe:b,modelsToBeUpdated:d}}});f.modelCleanups.push(f.removeViewHandler);
var La=g.cleanData;g.cleanData=function(a){f.removeView(a);La(a)};z.addViewHandler=function(a,b,d,e){f.addViewHandler(this,a,b,d,e);return this};var X=/^[\.\*]\w+/,na=/^\.([\.\*])/,Ca=/\s+/g,ya=/\s*@(\w+)(:([^@]+))*/g,Aa=/\s*;\s*/g,Ba=/(.+?)(,(.+?))?(,(.+))*$/,Da=/(.+?),(.+?),(.+?)(,(.+))*$/,E="class",Ea="mh,vh,class,theme,path,options".split(","),D={},O={};u.theme="via";t(f,{specialParsers:{},classMatchers:O,parseView:function(a){return g(a).each(function(){var a=g(this).data("via");if(a&&!a.parsed){if(a=
g(this).data("via")){if(!v(a)){a=ha(a);g(this).data("via",a);if(a.path&&"."!==a.path){if(X.exec(a.path))a.path=ma(this)+a.path}else a.path=ma(this);a.theme=a.theme||u.theme;var d={mh:[],vh:[]},e=a,h=E,i;if(!(i=a[E]))b:{for(var j in O)if(y.call(O,j)&&O[j](this)){i=j;break b}i=void 0}e[h]=i;ja(this,a,d);j=a;M("mh",this,j,d);M("vh",this,j,d);la(this,a,d);a=d}}else a=void 0;if(a){d=a.mh;j=a.vh;for(a=0;a<d.length;a++)e=d[a],f.addModelHandler(e.path,e.modelEvents,e.view,e.modelHandler,e.options);for(a=
0;a<j.length;a++)d=j[a],f.addViewHandler(d.view,d.viewEvents,d.path,d.viewHandler,d.options)}g(this).data("via").parsed=!0}})},themes:{via:{subThemes:l,bindingSet:{}}}});g.expr[":"].via=function(a){return!!g(a).data("via")};z.parseView=function(){return f.parseView(this)};g.fn.findAll=g.fn.findAll||function(a){if(0===this.length)return this;var b=this.filter(a);this.each(function(){b=b.add(g(this).find(a))});return b};f.renderTemplate=function(a,b,d,e){e=e||d&&d.engine||u.engine;if(!e)throw"there is not default engine registered";
e=pa[e||d&&d.engine||u.engine];if(!e)throw"engine '"+e+"' can not be found.";a=g(e.renderTemplate(a,b,d));d&&d.callback&&d.callback(a);return a};f.compileTemplate=function(a,b,d){d=d||u.engine;if(!d)throw"there is not default engine registered";d=pa[d];if(!d)throw"engine '"+d+"' can not be found.";return d.compileTemplate(a,b)};oa.buildOptions=Y.buildOptions=function(a){return m(a)?(a=a.split(","),{templateId:a[0],engineName:a[1]}):a};t(I,{template:Y,templateOne:oa});var pa=f.templateEngines={}}(jQuery,
window);
