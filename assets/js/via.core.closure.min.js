/*!
 * via JavaScript Library 0.1pre
 * http://semanticsworks.com/p/viaproxy.html
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Thu Nov 24 23:01:51 2011 -0500
 */
 window.jQuery&&window.via||function(g,R,k){function x(c){this.context=m(c||"",!0)}function t(c){return"object"===typeof c}function n(c){return"string"===typeof c}function C(c){return null===c||typeof c in aa}function I(c){return c===k}function u(c,a){0===a&&(a="0");var b,d,e=y,h=f.joinPath(c,a),g=m(h,!0),i=g.split(".");if(1===i.length)d=g;else{d=i[i.length-1];for(b=0;b<i.length-1&&!(e=e[i[b]],e===k);b++);}if(C(e))throw"invalid access proxy using path:"+h;return{physicalPath:g,logicalPath:h,hostObj:e,
index:d}}function D(c){this.mainPath=c}function m(c,a){if(!c)return"";if("*"===c)return i;var b=c.split("*");if(1===b.length)return c;var d=b[0],b=b[1],e=d.replace(S,"_");if(a&&d){var h=i+"."+e;!ba[e]&&o.get(d)!==k&&o.create(h,new D(d))}return!e?i+"."+b:b?i+"."+e+"."+b:i+"."+e}function T(c){if(c===i)return"*";var a=ca.exec(c);return a&&a[1]?a[2]?a[1].replace(J,".")+"*"+a[3]:a[1].replace(J,".")+"*":c}function E(c,a,b,d){var e,h=c.lastIndexOf(".");b&&(-1===h?(b="",e=c):(b=c.substring(0,h),e=c.substring(h+
1)),d(b,e,a));if(!C(a))for(e in a)z.call(a,e)&&(d(c,e,a[e]),E(c+"."+e,a[e],!1,d))}function U(c,a,b){if(l(b))for(var b=b.toString(),d,e,h,f;(d=da.exec(b))&&(e=d[1]);)c?(h=c+"."+a,f=c+"."+e):(h=a,f=e),j[f]=j[f]||[],j[f].pushUnique(h)}function ea(c,a){o.del(c+"."+a)}function V(c){var a,b,d=p[c.path];if(d)for(b=0;b<d.length;b++){a=d[b];if(W(a.modelEvents,c.eventType))c.options=a.options,K(a.view,a.modelHandler,c);if(!c.continueEventing)break}if((a=j[c.path])&&a.length)for(d=0;d<a.length;d++){b=q(a[d],
a[d],c.eventType,c.proposed===k?k:o.get(!0,a[d]));if(!b.continueEventing)break;if(b.hasError)c.hasError=!0}}function K(c,a,b){c===L&&(c=null);if(l(a))return a.call(c,b);if(n(a)){var d=a.substring(1),e=a.substring(2);if(0===a.indexOf("*")){if(d=M[d])return d.call(c,b)}else if(0===a.indexOf("$")){if(l(A[d])){a=b.currentValue();if(-1!="css,attr,prop".indexOf(d))b=b.options||b.targetIndex(),g(c)[d](b,a);else g(c)[d](a&&a.toString());return}}else if(0===a.indexOf("v.")&&c[e]){a=b.currentValue();if(l(c[e]))c[e](a);
else c[e]=a;return}}throw"handler: "+a+" not found";}function W(c,a){var b;if("*"===c)return!0;for(var c=c.split(X),d=0;d<c.length;d++){b=c[d];if(b===a)return!0;if(b=fa.exec(b))if(b[4])if(b[1]){if(N("^"+b[1]+"\\w*\\."+b[4]).test(a))return!0}else{if(N("^\\w+\\."+b[4]).test(a))return!0}else if(b[3]){if(b=b[1]?N("^"+b[1]+"(?!\\w*\\.\\w+)"):ga,b.test(a))return!0}else if(0===a.indexOf(b[1]))return!0}return!1}function w(c,a,b,d,e){t(c)?v(this,c):(this.path=c,this.target=a,this.eventType=b,!I(d)&&(this.proposed=
d),!I(e)&&(this.removed=e))}function Y(c,a){n(c)&&0===c.indexOf("*")&&(c=M[c.substring(1)]);l(c.buildOptions)&&(a=c.buildOptions(a));return a}function O(c){g(c).data(i,!0)}function F(c){return!0===g(c).data(i)}function G(c,a,b,d){t(c)?v(this,c):(this.path=c,this.options=a,this.e=b,this.triggerData=d)}function ha(c,a){var b=c.data,d=new G(b.path,b.options,c,a),b=b.viewHandler;if(l(b))return H(d,b.call(this,d));if(n(b)){var e=b.substring(1),f=b.substring(2);if(0===b.indexOf("*")){if(e=P[e]){e.call(this,
d);return}}else if(0===b.indexOf("$")){if(l(A[e]))return H(d,-1!="css,attr,prop".indexOf(e)?g(this)[e](d.options||d.targetIndex()):g(this)[e]())}else if(0===b.indexOf("p.")){if(l(Q[f])){d.targetProxy()[f](d);return}}else if(0===b.indexOf("v.")){if(e=this[f],l(e))return H(d,e.call(this,d))}else if(0===b.indexOf("m.")&&(e=o.get(!0,f),l(e)))return H(d,e.call(this,d))}throw"view handler: '"+b+"' not found";}function H(c,a){if(a!==k){var b=c.options;n(b)&&0===b.indexOf("*")&&(b=Z[b.substring(1)])&&(a=
b(a));o.update(c.path,a)}}var f=R.via=function(c){return new x(c)},v=g.extend,y={},$=g.isArray,ia=g.isPlainObject,l=g.isFunction,da=/this\.((?:\.?\w+)+)/g,aa={undefined:k,"boolean":k,number:k,string:k},i="__via",ja=/__via\.(\w+)/,ca=/__via\.(\w+)(\.(.+))*/,j={},B={},o,ba=y[i]={},J=/_/g,S=/\./g,z=y.hasOwnProperty,s=Array.prototype,ka=s.slice,q,Q=x.prototype={};s.indexOf=s.indexOf||function(c,a){for(var b=a||0;b<this.length;b++)if(this[b]==c)return b;return-1};s.contains=s.contains||function(c){return-1!==
this.indexOf(c)};s.remove=s.remove||function(c){c=this.indexOf(c);-1!=c&&this.splice(c,1);return this};s.pushUnique=s.pushUnique||function(c){-1===this.indexOf(c)&&this.push(c);return this};v(Q,{version:"0.1pre",constructor:x,pushProxy:function(c){c.oldProxy=this;return c},childProxy:function(c){return this.pushProxy(new x(f.joinPath(this.context,c)))},parentProxy:function(){return this.pushProxy(new f(f.contextOfPath(this.context)))},popProxy:function(){if(this.oldProxy)return this.oldProxy;throw"invalid operation, proxy.popProxy() failed because oldProxy is empty";
},shadowProxy:function(){return this.childProxy("*")},mainProxy:function(){var c;if(this.context===i)c="";else if((c=ja.exec(this.context))&&c[1])c=c[1].replace(J,".");else throw"proxy at '"+this.context+"' is already main proxy";return this.pushProxy(f(c))},triggerChange:function(c){c=this.physicalPath(c);q(c,c,"afterUpdate");return this},logicalPath:function(c){return T(f.joinPath(this.context,c))},physicalPath:function(c){return m(f.joinPath(this.context,c))},get:function(c,a){if(n(c)||"number"===
typeof c)a=""+c,c=!1;var b=u(this.context,a),d=!b.index?b.hostObj:b.hostObj[b.index];return!c&&l(d)?d.call(b.hostObj):d},call:function(c){var a=u(this.context,c),b=a.hostObj[a.index];if(!l(b))throw"object at '"+a.logicalPath+"' is not a function";return b.apply(a.hostObj,ka.call(arguments,1))},create:function(c,a,b){if(ia(c)){for(var d in c)if(z.call(c,d)&&(b=this.create(d,c[d],a),!b))return!1;return this}b=b||u(this.context,c);if(b.index in b.hostObj)throw"value at path: '"+b.logicalPath+"' has been defined, try use update method instead";
c=b.physicalPath;if(q(c,c,"beforeCreate",a).hasError)return!1;b.hostObj[b.index]=a;q(c,c,"afterCreate");E(c,a,!0,U);return this},update:function(c,a,b){if(""!==this.context&&1===arguments.length)return o.update(this.context,c);b=b||u(this.context,c);if(!(b.index in b.hostObj))throw"value at path: '"+b.logicalPath+"' has been not defined, try use create method instead";var d=b.physicalPath;if(q(d,d,"beforeUpdate",a).hasError)return!1;var e=b.hostObj[b.index];if(e===a)return this;b.hostObj[b.index]=
a;q(d,d,"afterUpdate",k,e);E(d,a,!0,U);return this},del:function(c,a){if(c===k)return o.del(this.context);var b=u(this.context,c);if(!a&&j[c]&&j[c].length)throw"can not remove path "+c+", because it is referenced!";var d=b.physicalPath;if(!a&&q(d,d,"beforeDel").hasError)return!1;var e=b.hostObj[b.index];E(d,e,!1,ea);$(b.hostObj)?b.hostObj.splice(b.index,1):delete b.hostObj[b.index];q(d,d,"afterDel",k,e);for(b=0;b<f.modelCleanups.length;b++)f.modelCleanups[b](d);return this},createOrUpdate:function(c,
a){var b=u(this.context,c);return b.index in b.hostObj?this.update(c,a,b):this.create(c,a,b)},createIfUndefined:function(c,a){var b=u(this.context,c);return b.index in b.hostObj?this:this.create(c,a,b)},updateAll:function(c){var a,b;for(b in c)if(z.call(c,b)&&(a=this.update(b,c[b]),!a))return!1;return this},isModelEmpty:function(c,a){var b=this.get(c,a);return!b?!0:!$(b)?!1:0===b.length},indexOf:function(c){return this.get().indexOf(c)},contains:function(c){return-1!==this.indexOf(c)},first:function(){return this.get("0")},
last:function(){var c=this.get();return c[c.length-1]},push:function(c){return this.create(this.get().length,c)},pushUnique:function(c){return!this.contains(c)?this.push(c):this},pop:function(){return this.removeAt(this.get().length-1)},insertAt:function(c,a){this.get().splice(c,0,a);q(this.context,this.context+"."+c,"afterCreate");return this},updateAt:function(c,a){return this.update(c,a)},removeAt:function(c){return this.del(c)},prepend:function(c){return this.insertAt(0,c)},swap:function(c,a){if(c==
a)return this;var b=this.indexOf(c);if(-1!=b)return this.updateAt(b,a);throw"oldItem not found";},removeItem:function(c){c=this.indexOf(c);return-1!==c?this.removeAt(c):this},clear:function(){var c=this.get();c.splice(0,c.length);q(this.context,this.context,"init");return this},count:function(){return this.get().length}});D.prototype={constructor:D,mainModel:function(){return o.get(this.mainPath)}};v(f,{fn:Q,joinPath:function(c,a){return!a?c:c?c+(0===a.toString().indexOf("*")?a:"."+a):a},accessor:u,
physicalPath:m,logicalPath:T,clearObj:function a(b){if(C(b))return null;for(var d in b)z.call(b,d)&&(b[d]=a(b[d]));return b},isUndefined:I,isPrimitive:C,isString:n,isObject:t,ns:function(){return i},Shadow:D,modelCleanups:[function(a){for(var b in j)j[b].remove(a),0===j[b].length&&delete j[b];for(var d in j)0===d.indexOf(a)&&delete j[d];0!==a.indexOf(i)&&o.del(i+"."+a.replace(S,"_"))}],addRef:function(a,b){a=m(a);b=m(b);j[b]=j[b]||[];j[b].pushUnique(a);return this},removeRef:function(a,b){a=m(a);
b=m(b);j[b].remove(a);j[b].length||delete j[b];return this},modelReferences:j,options:function(a,b){if(a===k)return B;if(t(a))return v(B,a),a;if(1===arguments.length)return B[a];if(b===k)delete B[a];else return B[a]=b},getAll:function(){var a=v({},y);delete a[i];return a},empty:function(){for(var a in y)a!==i&&o.del(a,!0)}});o=new x("");var fa=/(\w+)?(\*?)(\.?)([^\s]*)/,la=/^(.+)\.\w+$/,ma=/^.+\.(\w+)$|\w+/,L={},N=R.RegExp,p={},M={},X=/\s*\|\s*/,ga=/^\w+(?!\w*\.\w+)/,na=/^(\w+)\.?/,A=g.fn;q=function(a,
b,d,e,h){a=new w(a,b,d,e,h);V(a);if(a.continueEventing&&a.bubbleUp)for(a.eventType=na.exec(a.eventType)[1]+".child";((b=f.contextOfPath(a.path))||1)&&!(a.path=b,V(a),!a.continueEventing||!a.bubbleUp||""===b););return a};w.prototype={constructor:w,targetProxy:function(){return f(this.target)},targetValue:function(a){return f().get(a,this.target)},targetContext:function(){return f.contextOfPath(this.target)},targetIndex:function(){return f.indexOfPath(this.target)},bubbleUp:!0,continueEventing:!0,hasError:!1,
currentValue:function(a){return f().get(a,this.path)},currentProxy:function(){return f(this.path)},isModelEmpty:function(){var a=this.options,a=a?n(a)?"true"===a:!!a:!1;return this.currentProxy().isModelEmpty(a)}};O(L);v(f,{addModelHandler:function(a,b,d,e,h){if("once"===b)return this.renderViews(a,d,e,h);if(n(d)||l(d))h=e,e=d,d=L;"_"===h&&(h=k);a=m(a,!0);d=g(d);0<d.length&&!p[a]&&(p[a]=[]);d.each(function(){h=Y(e,h);O(this);p[a].push({view:this,modelHandler:e,modelEvents:b,options:h});W(b,"init")&&
K(this,e,new w({path:a,target:a,eventType:"init",options:h}))});return f},removeModelHandler:function(a){if(n(a)){var a=m(a),b;for(b in p)0===b.indexOf(a)&&delete p[b]}else t(a)&&g(a).each(function(a,b){if(F(b))for(var f in p){for(var g=p[f],i=g.length-1;0<=i;i--)g[i].view===b&&g.splice(i,1);0===g.length&&delete p[f]}});return f},getModelHandlerData:function(a){if(n(a))return p[m(a)];if(t(a)){if(!F(a))return;var b={},d;for(d in p)for(var e=p[d],f=e.length-1;0<=f;f--)e[f].view===a&&(b[d]=b[d]||[],
b[d].push(e[f]));return b}if(!a)return p},renderViews:function(a,b,d,e){a=m(a,!0);g(b).each(function(){e=Y(d,e);K(this,d,new w({path:a,target:a,eventType:"init",options:e}))});return f},ModelEvent:w,commonModelHandlers:M,raiseEvent:q,indexOfPath:function(a){a=ma.exec(a);return a[1]||a[0]},contextOfPath:function(a){return(a=la.exec(a))&&a[1]||""}});f.modelCleanups.push(f.removeModelHandler);A.addModelHandler=function(a,b,d,e){f.addModelHandler(a,b,this,d,e);return this};A.renderViews=function(a,b,
d){f.renderViews(a,this,b,d);return this};var P={},Z={},r={};G.prototype={constructor:G,targetProxy:function(){return f(this.path)},targetValue:function(a){return o.get(a,this.path)},targetContext:function(){return f.contextOfPath(this.path)},targetIndex:function(){return f.indexOfPath(this.path)},updateModel:function(a){return o.update(this.path,a)},returnFalse:function(){this.e.stopPropagation();this.e.preventDefault()},stopPropagation:function(){this.e.stopPropagation()},stopImmediatePropagation:function(){this.e.stopImmediatePropagation()}};
v(f,{addViewHandler:function(a,b,d,e,h){var d=m(d,!0),j=e;"_"===h&&(h=k);n(e)&&0===e.indexOf("*")&&(e=P[e.substring(1)]);l(e.buildOptions)&&(h=e.buildOptions(a,h));l(e.initialize)&&e.initialize(a);g(a).each(function(){O(this);b=g.map(b.split(X),function(a){return a+"."+i+"."+d}).toString();g(this).bind(b,{viewHandler:e,path:d,options:h,originalHandler:j},ha);r[d]=r[d]||[];r[d].pushUnique(this)});return f},removeViewHandler:function(a){n(a)?(a=m(a),g(r[a]).unbind("."+i+"."+a),delete r[a]):t(a)&&(g(a).unbind("."+
i),g(a).each(function(){for(var a in r)r[a].remove(this)}));return f},removeView:function(a){g(a).each(function(a,d){F(this)&&(f.removeModelHandler(d).removeViewHandler(d),g(this).removeData(i))});return f},commonViewHandlers:P,valueConverters:Z,ViewEvent:G,getViewHandlerData:function(a){if(n(a))return r[a];if(t(a)){if(!F(a))return;var b=[],d;for(d in r)z.call(r,d)&&r[d].contains(a)&&b.push(d);return b}if(!a)return r},getHandlerData:function(a){var b=f.getModelHandlerData(a),d=f.getViewHandlerData(a);
return n(a)?{viewsToBeUpdated:b,viewsUpdatingMe:d}:{modelsUpdatingMe:b,modelsToBeUpdated:d}}});f.modelCleanups.push(f.removeViewHandler);var oa=g.cleanData;g.cleanData=function(a){f.removeView(a);oa(a)};A.addViewHandler=function(a,b,d,e){f.addViewHandler(this,a,b,d,e);return this}}(jQuery,window);
