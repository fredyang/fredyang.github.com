/*!
 * viaProxy.js JavaScript Library 0.2pre
 * http://semanticsworks.com
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Wed Dec 14 01:37:31 2011 -0500
 */
 window.jQuery&&window.via||function(f,la,j){function I(c){this.context=r(c||"",!0)}function v(c){return"object"===typeof c}function n(c){return"string"===typeof c}function S(c){return null===c||typeof c in Ha}function aa(c){return c===j}function x(c,a){0===a&&(a="0");var b,d,e=J,g=h.joinPath(c,a),f=r(g,!0),K=f.split(".");if(1===K.length)d=f;else{d=K[K.length-1];for(b=0;b<K.length-1&&!(e=e[K[b]],e===j);b++);}if(S(e))throw"invalid access proxy using path:"+g;return{physicalPath:f,logicalPath:g,hostObj:e,
index:d}}function T(c){this.mainPath=c}function r(c,a){if(!c)return"";if("*"===c)return l;var b=c.split("*");if(1===b.length)return c;var d=b[0],b=b[1],e=d.replace(ba,"_");if(a&&d){var g=l+"."+e;!ma[e]&&k.get(d)!==j&&k.create(g,new T(d))}return!e?l+"."+b:b?l+"."+e+"."+b:l+"."+e}function na(c){if(c===l)return"*";var a=Ia.exec(c);return a&&a[1]?a[2]?a[1].replace(ca,".")+"*"+a[3]:a[1].replace(ca,".")+"*":c}function U(c,a,b,d){var e,g=c.lastIndexOf(".");b&&(-1===g?(b="",e=c):(b=c.substring(0,g),e=c.substring(g+
1)),d(b,e,a));if(!S(a))for(e in a)z.call(a,e)&&(d(c,e,a[e]),U(c+"."+e,a[e],!1,d))}function oa(c,a,b){if(p(b))for(var b=b.toString(),d,e,g,f;(d=Ja.exec(b))&&(e=d[1]);)c?(g=c+"."+a,f=c+"."+e):(g=a,f=e),m[f]=m[f]||[],m[f].pushUnique(g)}function Ka(c,a){k.del(c+"."+a)}function pa(c){var a,b,d=q[c.path];if(d)for(b=0;b<d.length;b++){a=d[b];if(qa(a.modelEvents,c.eventType))c.options=a.options,da(a.view,a.modelHandler,c);if(!c.continueEventing)break}if((a=m[c.path])&&a.length)for(d=0;d<a.length;d++){b=s(a[d],
a[d],c.eventType,c.proposed===j?j:k.get(!0,a[d]));if(!b.continueEventing)break;if(b.hasError)c.hasError=!0}}function da(c,a,b){c===ea&&(c=null);if(p(a))return a.call(c,b);if(n(a)){var d=a.substring(1),e=a.substring(2);if(a.beginsWith("*")){if(d=w[d])return d.call(c,b)}else if(a.beginsWith("$")){if(p(B[d])){a=b.currentValue();if("css,attr,prop".contains(d))b=b.options||b.targetIndex(),f(c)[d](b,a);else f(c)[d](a&&a.toString());return}}else if(a.beginsWith("v.")&&c[e]){a=b.currentValue();if(p(c[e]))c[e](a);
else c[e]=a;return}}throw"handler: "+a+" not found";}function qa(c,a){var b;if("*"===c)return!0;for(var c=c.split(ra),d=0;d<c.length;d++){b=c[d];if(b===a)return!0;if(b=La.exec(b))if(b[4])if(b[1]){if(C("^"+b[1]+"\\w*\\."+b[4]).test(a))return!0}else{if(C("^\\w+\\."+b[4]).test(a))return!0}else if(b[3]){if(b=b[1]?C("^"+b[1]+"(?!\\w*\\.\\w+)"):Ma,b.test(a))return!0}else if(a.beginsWith(b[1]))return!0}return!1}function D(c,a,b,d,e){v(c)?i(this,c):(this.path=c,this.target=a,this.eventType=b,!aa(d)&&(this.proposed=
d),!aa(e)&&(this.removed=e))}function sa(c,a,b){n(a)&&a.beginsWith("*")&&(a=w[a.substring(1)]);p(a.buildOptions)&&(b=a.buildOptions.call(c,b));return b}function fa(c){f(c).data(l,!0)}function V(c){return!0===f(c).data(l)}function L(c,a,b,d){v(c)?i(this,c):(this.path=c,this.options=a,this.e=b,this.triggerData=d)}function Na(c,a){var b=c.data,d=new L(b.path,b.options,c,a),b=b.viewHandler;if(p(b))return W(d,b.call(this,d));if(n(b)){var e=b.substring(1),g=b.substring(2);if(b.beginsWith("*")){if(e=M[e]){e.call(this,
d);return}}else if(b.beginsWith("$")){if(p(B[e]))return W(d,"css,attr,prop".contains(e)?f(this)[e](d.options||d.targetIndex()):f(this)[e]())}else if(b.beginsWith("p.")){if(p(E[g])){d.targetProxy()[g](d);return}}else if(b.beginsWith("v.")){if(e=this[g],p(e))return W(d,e.call(this,d))}else if(b.beginsWith("m.")&&(e=k.get(!0,g),p(e)))return W(d,e.call(this,d))}throw"view handler: '"+b+"' not found";}function W(c,a){if(a!==j){var b=c.options;n(b)&&b.beginsWith("*")&&(b=ga[b.substring(1)])&&(a=b(a));k.update(c.path,
a)}}function ta(c){var a=c.data,b=f(c.target).data("via");(b=b&&b.viewEvents&&b.viewEvents[a])&&f(c.target).trigger(i({},c,{type:a+"."+b,currentTarget:c.target}))}function ua(c){if(!n(c))throw"bindingText must non-empty string";for(var a={},b,d;b=Oa.exec(c);)d=b[1],b=b[3]&&f.trim(b[3])||!0,a[d]=a[d]?a[d]+";"+b:b;return a}function Pa(c){if(!c)return!1;var a;a:{a=c+".";for(var b in N)if(b.beginsWith(a)){a=!0;break a}a=!1}if(a)return!0;a=va(c);if(!a)return!1;b=0;for(var d;d=a[b];b++)for(var e in d){var g=
d[e],f=c+"."+e;N[f]=N[f]?N[f]+g:g}return!0}function va(c){var a=h.themes[c];if(a){c=[];a.bindingSet&&c.push(a.bindingSet);if(a=a.subThemes)for(var a=a.split(";"),b=0;b<a.length;b++)c=c.concat(va(a[b]));return c}}function wa(c,a,b){if(a[O]&&"_"!==a[O]&&Pa(a.theme))for(var d=a[O].split(Qa),e,g=0;g<d.length;g++){var f=Ra.exec(d[g]);if(e=N[a.theme+"."+f[1]]){e=ua(e);e.path=xa(a.path,f[3]);e.theme=a.theme;e.options=f[5]||a.options;wa(c,e,b);var f=c,h=e,i=b;X("mh",f,h,i);X("vh",f,h,i);ya(c,e,b)}}}function za(c){for(c=
f(c);(c=c.parent())&&c.length;){var a=c.data("via");if(a&&a.path)return a.path}return""}function xa(c,a){if(!a||"."==a)return c;if(Aa.test(a))return a.replace(Aa,h.contextOfPath(c)+"$1");if(ha.test(a)){var b=/^(.+)\*/.exec(c);return b&&b[1]&&a.beginsWith("*")?b[1]+a:a.replace(ha,c+"$&")}return a}function X(c,a,b,d){var e,g,f,h;if(h=b[c]&&b[c].replace(Sa,"").split(";"))for(e=0;e<h.length;e++)if(g=Ta.exec(h[e]))f=xa(b.path,g[1]),d[c].push("mh"===c?{path:f,modelEvents:g[2],view:a,modelHandler:g[3],options:g[5]||
b.options}:{path:f,viewEvents:g[2],view:a,viewHandler:g[3],options:g[5]||b.options})}function ya(c,a,b){var d,e;for(e in a)z.call(a,e)&&!Ua.contains(e)&&(d=y[e])&&d(c,a,b,a[e])}function ia(c){var a=c.currentValue();a&&(P(a)&&a.length||!P(a))?(c=c.options,c.callback=function(a){f(this).html(a);a.view()},h.renderTemplate.call(this,c.templateId,a,c)):f(this).empty()}function Ba(c){var a=c.currentValue();c.currentValue=function(){return[a]};ia.call(this,c)}function Ca(c){if(""===c)return!Y.length;for(var a=
c+".",b=0;b<Y.length;b++)if(Y[b]==c||Y[b].beginsWith(a))return!1;return!0}function Da(c){f.each(ja.call(arguments,1),function(a,b){c=c.replace(new C("\\{"+a+"\\}","g"),b)});return c}function Ea(c){var a=function(a){var d,e;if(null===a.proposed||a.proposed===j||Va.test(a.proposed)){a:{d=a.path;d=r(d);d=q[d];for(var g=0;g<d.length;g++)if("*required"===d[g].modelHandler){d=!1;break a}d=!0}d?d=!0:(d=!1,e=!0)}else d=c.isValid(a.proposed,a.options);var g=c.name&&o.errors[c.name],f=a.options,h=v(f)?f.userError:
f,g=c.buildError?c.buildError(g,f):g&&g.contains("{0}")?Da.apply(null,[g].concat(h.split(","))):h||g||c.error;!d&&(!e||"required"===c.name)?a.addError(g):a.removeError(g);if(!d)a.hasError=!0};if(c.buildOptions)a.buildOptions=c.buildOptions,delete c.buildOptions;return a}function F(c,a){return a?function(a){return!c.test(a)}:function(a){return c.test(a)}}function G(){var c=ja.call(arguments,0);return function(a,b){return b.userError||Da.apply(null,[a].concat(f.map(c,function(a){return b[a]})))}}function H(c){return c.replace(ba,
"_")}var h=la.via=function(c){return new I(c)},i=f.extend,J={},P=f.isArray,Wa=f.isPlainObject,p=f.isFunction,Ja=/this\.((?:\.?\w+)+)/g,Ha={undefined:j,"boolean":j,number:j,string:j},l="__via",Xa=/__via\.(\w+)/,Ia=/__via\.(\w+)(\.(.+))*/,m={},o={},k,ma=J[l]={},ca=/_/g,ba=/\./g,z=J.hasOwnProperty,u=Array.prototype,ja=u.slice,s,E=I.prototype={};u.indexOf=u.indexOf||function(c,a){for(var b=a||0;b<this.length;b++)if(this[b]==c)return b;return-1};u.contains=u.contains||function(c){return-1!==this.indexOf(c)};
u.remove=u.remove||function(c){c=this.indexOf(c);-1!=c&&this.splice(c,1);return this};u.pushUnique=u.pushUnique||function(c){this.contains(c)||this.push(c);return this};u.sortObject=u.sortObject||function(c,a){c?this.sort(function(b,d){var e=b[c],g=d[c];return e==g?0:a?e>g?1:-1:e>g?-1:1}):a?this.sort():this.sort().reverse()};var Z=String.prototype;Z.beginsWith=Z.beginsWith||function(c){return 0===this.indexOf(c)};Z.contains=Z.contains||function(c){return-1!==this.indexOf(c)};i(E,{version:"0.2pre",
constructor:I,pushProxy:function(c){c.oldProxy=this;return c},childProxy:function(c){return this.pushProxy(new I(h.joinPath(this.context,c)))},parentProxy:function(){return this.pushProxy(new h(h.contextOfPath(this.context)))},popProxy:function(){if(this.oldProxy)return this.oldProxy;throw"invalid operation, proxy.popProxy() failed because oldProxy is empty";},shadowProxy:function(){return this.childProxy("*")},mainProxy:function(){var c;if(this.context===l)c="";else if((c=Xa.exec(this.context))&&
c[1])c=c[1].replace(ca,".");else throw"proxy at '"+this.context+"' is already main proxy";return this.pushProxy(h(c))},triggerChange:function(c){c=this.physicalPath(c);s(c,c,"afterUpdate");return this},logicalPath:function(c){return na(h.joinPath(this.context,c))},physicalPath:function(c){return r(h.joinPath(this.context,c))},get:function(c,a){if(n(c)||"number"===typeof c)a=""+c,c=!1;var b=x(this.context,a),d=!b.index?b.hostObj:b.hostObj[b.index];return!c&&p(d)?d.call(b.hostObj):d},call:function(c){var a=
x(this.context,c),b=a.hostObj[a.index];if(!p(b))throw"object at '"+a.logicalPath+"' is not a function";return b.apply(a.hostObj,ja.call(arguments,1))},create:function(c,a,b){if(Wa(c)){for(var d in c)if(z.call(c,d)&&(b=this.create(d,c[d],a),!b))return!1;return this}b=b||x(this.context,c);if(b.index in b.hostObj)throw"value at path: '"+b.logicalPath+"' has been defined, try use update method instead";c=b.physicalPath;if(s(c,c,"beforeCreate",a).hasError)return!1;b.hostObj[b.index]=a;s(c,c,"afterCreate");
U(c,a,!0,oa);return this},update:function(c,a,b){if(""!==this.context&&1===arguments.length)return k.update(this.context,c);b=b||x(this.context,c);if(!(b.index in b.hostObj))throw"value at path: '"+b.logicalPath+"' has been not defined, try use create method instead";var d=b.physicalPath;if(s(d,d,"beforeUpdate",a).hasError)return!1;var e=b.hostObj[b.index];if(e===a)return this;b.hostObj[b.index]=a;s(d,d,"afterUpdate",j,e);U(d,a,!0,oa);return this},del:function(c,a){if(c===j)return k.del(this.context);
var b=x(this.context,c);if(!a&&m[c]&&m[c].length)throw"can not remove path "+c+", because it is referenced!";var d=b.physicalPath;if(!a&&s(d,d,"beforeDel").hasError)return!1;var e=b.hostObj[b.index];U(d,e,!1,Ka);P(b.hostObj)?b.hostObj.splice(b.index,1):delete b.hostObj[b.index];s(d,d,"afterDel",j,e);for(b=0;b<h.modelCleanups.length;b++)h.modelCleanups[b](d);return this},createOrUpdate:function(c,a){var b=x(this.context,c);return b.index in b.hostObj?this.update(c,a,b):this.create(c,a,b)},createIfUndefined:function(c,
a){var b=x(this.context,c);return b.index in b.hostObj?this:this.create(c,a,b)},updateAll:function(c){var a,b;for(b in c)if(z.call(c,b)&&(a=this.update(b,c[b]),!a))return!1;return this},isModelEmpty:function(c,a){var b=this.get(c,a);return!b?!0:!P(b)?!1:0===b.length},indexOf:function(c){return this.get().indexOf(c)},contains:function(c){return-1!==this.indexOf(c)},first:function(){return this.get("0")},last:function(){var c=this.get();return c[c.length-1]},push:function(c){return this.create(this.get().length,
c)},pushRange:function(c){for(var a=0;a<c.length;a++)this.push(c[a]);return this},pushUnique:function(c){return!this.contains(c)?this.push(c):this},pop:function(){return this.removeAt(this.get().length-1)},insertAt:function(c,a){this.get().splice(c,0,a);s(this.context,this.context+"."+c,"afterCreate");return this},updateAt:function(c,a){return this.update(c,a)},removeAt:function(c){return this.del(c)},prepend:function(c){return this.insertAt(0,c)},swap:function(c,a){if(c==a)return this;var b=this.indexOf(c);
if(-1!=b)return this.updateAt(b,a);throw"oldItem not found";},removeItem:function(c){c=this.indexOf(c);return-1!==c?this.removeAt(c):this},clear:function(){var c=this.get();c.splice(0,c.length);s(this.context,this.context,"init");return this},count:function(){return this.get().length},sort:function(c,a){return h.raiseEvent(this.context,this.context,"init",this.get().sortObject(c,a))}});T.prototype={constructor:T,mainModel:function(){return k.get(this.mainPath)}};i(h,{fn:E,joinPath:function(c,a){return!a?
c:c?c+(a.toString().beginsWith("*")?a:"."+a):a},accessor:x,physicalPath:r,logicalPath:na,clearObj:function a(b){if(S(b))return null;for(var d in b)z.call(b,d)&&(b[d]=a(b[d]));return b},isUndefined:aa,isPrimitive:S,isString:n,isObject:v,ns:function(){return l},Shadow:T,modelCleanups:[function(a){for(var b in m)m[b].remove(a),0===m[b].length&&delete m[b];for(var d in m)d.beginsWith(a)&&delete m[d];a.beginsWith(l)||k.del(l+"."+a.replace(ba,"_"))}],addRef:function(a,b){a=r(a);b=r(b);m[b]=m[b]||[];m[b].pushUnique(a);
return this},removeRef:function(a,b){a=r(a);b=r(b);m[b].remove(a);m[b].length||delete m[b];return this},modelReferences:m,options:function(a,b){if(a===j)return o;if(v(a))return i(o,a),a;if(1===arguments.length)return o[a];if(b===j)delete o[a];else return o[a]=b},getAll:function(){var a=i({},J);delete a[l];return a},empty:function(){for(var a in J)a!==l&&k.del(a,!0)}});k=new I("");var La=/(\w+)?(\*?)(\.?)([^\s]*)/,Ya=/^(.+)\.\w+$/,Za=/^.+\.(\w+)$|\w+/,ea={},C=la.RegExp,q={},w={},ra=/\s*\|\s*/,Ma=/^\w+(?!\w*\.\w+)/,
$a=/^(\w+)\.?/,B=f.fn;s=function(a,b,d,e,g){a=new D(a,b,d,e,g);pa(a);if(a.continueEventing&&a.bubbleUp)for(a.eventType=$a.exec(a.eventType)[1]+".child";((b=h.contextOfPath(a.path))||1)&&!(a.path=b,pa(a),!a.continueEventing||!a.bubbleUp||""===b););return a};D.prototype={constructor:D,targetProxy:function(){return h(this.target)},targetValue:function(a){return h().get(a,this.target)},targetContext:function(){return h.contextOfPath(this.target)},targetIndex:function(){return h.indexOfPath(this.target)},
bubbleUp:!0,continueEventing:!0,hasError:!1,currentValue:function(a){return h().get(a,this.path)},currentProxy:function(){return h(this.path)},isModelEmpty:function(){var a=this.options,a=a?n(a)?"true"===a:!!a:!1;return this.currentProxy().isModelEmpty(a)}};fa(ea);i(h,{addModelHandler:function(a,b,d,e,g){if("once"===b)return this.renderViews(a,d,e,g);if(n(d)||p(d))g=e,e=d,d=ea;"_"===g&&(g=j);a=r(a,!0);d=f(d);0<d.length&&!q[a]&&(q[a]=[]);d.each(function(){g=sa(this,e,g);fa(this);q[a].push({view:this,
modelHandler:e,modelEvents:b,options:g});qa(b,"init")&&da(this,e,new D({path:a,target:a,eventType:"init",options:g}))});return h},removeModelHandler:function(a){if(n(a)){var a=r(a),b;for(b in q)b.beginsWith(a)&&delete q[b]}else v(a)&&f(a).each(function(a,b){if(V(b))for(var g in q){for(var f=q[g],h=f.length-1;0<=h;h--)f[h].view===b&&f.splice(h,1);0===f.length&&delete q[g]}});return h},getModelHandlerData:function(a){if(n(a))return q[r(a)];if(v(a)){if(!V(a))return;var b={},d;for(d in q)for(var e=q[d],
g=e.length-1;0<=g;g--)e[g].view===a&&(b[d]=b[d]||[],b[d].push(e[g]));return b}if(!a)return q},renderViews:function(a,b,d,e){a=r(a,!0);f(b).each(function(){e=sa(this,d,e);da(this,d,new D({path:a,target:a,eventType:"init",options:e}))});return h},ModelEvent:D,commonModelHandlers:w,raiseEvent:s,indexOfPath:function(a){a=Za.exec(a);return a[1]||a[0]},contextOfPath:function(a){return(a=Ya.exec(a))&&a[1]||""}});h.modelCleanups.push(h.removeModelHandler);B.addModelHandler=function(a,b,d,e){h.addModelHandler(a,
b,this,d,e);return this};B.renderViews=function(a,b,d){h.renderViews(a,this,b,d);return this};var M={},ga={},t={};L.prototype={constructor:L,targetProxy:function(){return h(this.path)},targetValue:function(a){return k.get(a,this.path)},targetContext:function(){return h.contextOfPath(this.path)},targetIndex:function(){return h.indexOfPath(this.path)},updateModel:function(a){return k.update(this.path,a)},returnFalse:function(){this.e.stopPropagation();this.e.preventDefault()},stopPropagation:function(){this.e.stopPropagation()},
stopImmediatePropagation:function(){this.e.stopImmediatePropagation()}};i(h,{addViewHandler:function(a,b,d,e,g){var d=r(d,!0),i=e;"_"===g&&(g=j);n(e)&&e.beginsWith("*")&&(e=M[e.substring(1)]);p(e.buildOptions)&&(g=e.buildOptions(a,g));p(e.initialize)&&e.initialize(a);f(a).each(function(){fa(this);b=f.map(b.split(ra),function(a){return a+"."+l+"."+d}).toString();f(this).bind(b,{viewHandler:e,path:d,options:g,originalHandler:i},Na);t[d]=t[d]||[];t[d].pushUnique(this)});return h},removeViewHandler:function(a){n(a)?
(a=r(a),f(t[a]).unbind("."+l+"."+a),delete t[a]):v(a)&&(f(a).unbind("."+l),f(a).each(function(){for(var a in t)t[a].remove(this)}));return h},removeView:function(a){f(a).each(function(a,d){V(this)&&(h.removeModelHandler(d).removeViewHandler(d),f(this).removeData(l))});return h},commonViewHandlers:M,valueConverters:ga,ViewEvent:L,getViewHandlerData:function(a){if(n(a))return t[a];if(v(a)){if(!V(a))return;var b=[],d;for(d in t)z.call(t,d)&&t[d].contains(a)&&b.push(d);return b}if(!a)return t},getHandlerData:function(a){var b=
h.getModelHandlerData(a),d=h.getViewHandlerData(a);return n(a)?{viewsToBeUpdated:b,viewsUpdatingMe:d}:{modelsUpdatingMe:b,modelsToBeUpdated:d}}});h.modelCleanups.push(h.removeViewHandler);var ab=f.cleanData;f.cleanData=function(a){h.removeView(a);ab(a)};h.forwardEvent=function(a,b,d){var e=function(a){d(a)&&f(a.target).trigger(i({},a,{type:b,currentTarget:a.target}))};if(f.event.special[b])throw"event '"+b+"' has been defined";f.event.special[b]={setup:function(){f(this).bind(a,e)},teardown:function(){f(this).unbind(a,
e)}};return h};h.addViaEvent=function(a,b){f.event.special[a]={setup:function(){f(this).bind(b,a,ta)},teardown:function(){f(this).unbind(b,ta)}};return h};B.addViewHandler=function(a,b,d,e){h.addViewHandler(this,a,b,d,e);return this};var ha=/^[\.\*]\w+/,Aa=/^\.([\.\*])/,Sa=/\s+/g,Oa=/\s*@(\w+)(:([^@]+))*/g,Qa=/\s*;\s*/g,Ra=/(.+?)(,(.+?))?(,(.+))*$/,Ta=/(.+?),(.+?),(.+?)(,(.+))*$/,O="class",Ua="mh,vh,class,theme,path,options".split(","),N={},$={},y,Q;o.theme="via";i(h,{specialParsers:y={},classMatchers:$,
view:function(a){return f(a||":via").each(function(){if(!f(this).data("via")){var a;if(a=f(this).attr("via")){a=ua(a);f(this).data("via",a);if(a.path&&"."!==a.path){if(ha.exec(a.path))a.path=za(this)+a.path}else a.path=za(this);a.theme=a.theme||o.theme;var d={mh:[],vh:[]},e=a,g=O,i;if(!(i=a[O]))b:{for(var k in $)if(z.call($,k)&&$[k](this)){i=k;break b}i=void 0}e[g]=i;wa(this,a,d);e=a;X("mh",this,e,d);X("vh",this,e,d);ya(this,a,d);a=d}else a=void 0;if(a){d=a.mh;e=a.vh;for(a=0;a<d.length;a++)g=d[a],
h.addModelHandler(g.path,g.modelEvents,g.view,g.modelHandler,g.options);for(a=0;a<e.length;a++)d=e[a],h.addViewHandler(d.view,d.viewEvents,d.path,d.viewHandler,d.options)}}})},themes:{via:{subThemes:j,bindingSet:Q={}}}});y.viaEvent=function(a,b,d,e){if(!b.viewEvents)b.viewEvents={};a=e.split(",");for(d=0;d<a.length;d++)e=a[d].split("."),b.viewEvents[e[0]]=e[1]};f.expr[":"].via=function(a){return!!f(a).attr("via")};B.view=function(){h.view(this.findAll(":via"));return this};f.fn.findAll=f.fn.findAll||
function(a){if(0===this.length)return this;var b=this.filter(a);this.each(function(){b=b.add(f(this).find(a))});return b};h.renderTemplate=function(a,b,d,e){e=e||d&&d.engine||o.engine;if(!e)throw"there is not default engine registered";var g=this,h=d&&(f.isFunction(d)?d:d.callback),i=A[e||d&&d.engine||o.engine],d=d||{};d.get=function(a){return k.get(a)};if(!i)throw"engine '"+i+"' can not be found.";var j;if(i.isTemplateCompiled(a))return j=f(i.renderTemplate(a,b,d)),h&&h.call(g,j),j;if("undefined"!==
typeof matrix){var l=f.Deferred();matrix(matrix.resourceName(a)+".template").done(function(){j=f(i.renderTemplate(a,b,d));l.resolve(j)});return l.promise().done(function(){h&&h.call(g,j)})}throw"can not locate template for '"+a+"'";};f.fn.renderTemplate=function(a,b,d,e){return this.each(function(){h.renderTemplate.call(this,a,b,d,e)})};h.compileTemplate=function(a,b,d){d=d||o.engine;if(!d)throw"there is not default engine registered";d=A[d];if(!d)throw"engine '"+d+"' can not be found.";return d.compileTemplate(a,
b)};h.isTemplateComplied=function(a,b){b=b||o.engine;if(!b)throw"there is not default engine registered";var d=A[b];if(!d)throw"engine '"+d+"' can not be found.";return d.isTemplateComplied(a)};Ba.buildOptions=ia.buildOptions=function(a){return n(a)?(a=a.split(","),{templateId:f.trim(a[0]),engineName:a[1]}):a};i(w,{template:ia,templateOne:Ba});var A=h.templateEngines={};if(f.tmpl)o.engine="tmpl",A.tmpl={renderTemplate:function(a,b,d){return a.beginsWith("#")?f(a).tmpl(b,d):f.tmpl(a,b,d)},compileTemplate:function(a,
b){f.template(a,b)},isTemplateCompiled:function(a){return a.beginsWith("#")?!!f(a).length:!!f.template[a]}};else if(f.render)o.engine="jsrender",A.jsrender={renderTemplate:function(a,b,d){return a.beginsWith("#")?f(a).render(b,d):f.render(b,a,d)},compileTemplate:function(a,b){f.template(a,b)},isTemplateCompiled:function(a){return a.beginsWith("#")?!!f(a).length:!!f.views.templates[a]}};A.tmpl&&h.compileTemplate("ddl_tmpl","<option value='${this.value($data)}'>${this.name($data)}</option>");A.jsrender&&
h.compileTemplate("ddl_jsrender","<option value='{{=$ctx.value($data)}}'>{{=$ctx.name($data)}}</option>","jsrender");i(w,{dropdown:i(function(a){w.template.call(this,a)},{buildOptions:function(a){var b=(a||"").split(","),a=1===b.length?{name:function(a){return a.toString()},value:function(a){return a.toString()},engine:a}:{name:function(a){return a[b[0]]},value:function(a){return a[b[1]]},engine:b[2]};a.templateId="ddl_"+(a.engine||o.engine);return a}}),pushViewItem:function(a){f(this).renderTemplate(a.options,
a.targetValue(),function(a){a.appendTo(this).view()})},removeViewItem:function(a){f(this).children().eq(+a.targetIndex()).remove()},updateViewItem:function(a){f(this).renderTemplate(a.options,a.targetValue(),function(b){f(this).children().eq(a.targetIndex()).replaceWith(b);b.view()})},showIfTruthy:function(a){f(this)[a.isModelEmpty()?"hide":"show"]()},showIfFalsy:function(a){f(this)[a.isModelEmpty()?"show":"hide"]()},enableIfTruthy:function(a){f(this).attr("disabled",a.isModelEmpty())},enableIfFalsy:function(a){f(this).attr("disabled",
!a.isModelEmpty())},val:function(a){a=a.currentValue();a!==f(this).val()&&f(this).val(a)}});i(M,{value:function(a){return p(a.options)?a.options():a.options},evalOptions:function(a){return eval(a.options)},stringOptions:function(a){return a.options},numberOptions:function(a){return+a.options},trueValue:function(){return!0},falseValue:function(){return!1},toggle:function(a){return!a.targetValue()},trueIfCheck:function(){return this.checked},trueIfUncheck:function(){return!this.checked},returnFalse:function(a){a.returnFalse()},
preventDefault:function(a){a.e.preventDefault()},stopBubble:function(a){a.e.stopImmediatePropagation()}});i(ga,{toNumber:function(a){return+a},toDate:function(a){return new Date(a)},toString:function(a){return null===a||a===j?"":""+a}});Q.simpleList="@mh:.,init|afterUpdate,*template;.,afterCreate.child,*pushViewItem;.,afterUpdate.child,*updateViewItem;.,afterDel.child,*removeViewItem,_";y.lookup=function(a,b,d,e){var e=/^(.+?),(.*)$/.exec(e),f=b.path;d.mh.push({path:e[1],modelEvents:"init",view:a,
modelHandler:"*dropdown",options:e[2]});f&&(d.mh.push({path:b.path,modelEvents:"afterUpdate",view:a,modelHandler:"*val"}),d.vh.push({path:b.path,viewEvents:"change",view:a,viewHandler:"$val"}))};h.classMatchers.textBox=function(a){return f(a).is(":text")};i(Q,{textBox:"@mh:.,init|after*,*val@vh:.,keyup,$val",label:"@mh:.,init|after*,$html"});o.errors={required:"This field is required.",email:"Please enter a valid email address.",url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",
number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equal:"Please enter the same value again.",accept:"Please enter a value with a valid extension.",maxlength:"Please enter no more than {0} characters.",minlength:"Please enter at least {0} characters.",rangelength:"Please enter a value between {0} and {1} characters long.",range:"Please enter a value between {0} and {1}.",max:"Please enter a value less than or equal to {0}.",
min:"Please enter a value greater than or equal to {0}."};var Y=ma.invalidModelPaths=[],ka=h("*invalidModelPaths"),Va=/^\s*$/,Fa=/^\d+$/,bb=/^(\/(\\[^\x00-\x1f]|\[(\\[^\x00-\x1f]|[^\x00-\x1f\\\/])*\]|[^\x00-\x1f\\\/\[])+\/[gim]*)(,(.*))$/,R=/(\w+)(,(.*))?/,Ga=/(\w+),(\w+)(,(.*))?/;E.isValid=function(){var a=this.context+"*invalidated";if(k.get(a))return Ca(this.context);k.create(a,!0);for(var b in q)if(b.beginsWith(this.context))for(var a=q[b],d=0;d<a.length;d++){var e=a[d];if("beforeUpdate"===e.modelEvents){s({path:b,
eventType:e.modelEvents,target:b,proposed:h().get(b)});s({path:b,eventType:"init",target:b});break}}return Ca(this.context)};i(h.ModelEvent.prototype,{addError:function(a){this.currentProxy().createIfUndefined("*errors",[]).childProxy("*errors").pushUnique(a);ka.pushUnique(this.path)},removeError:function(a){this.currentProxy().createIfUndefined("*errors",[]).childProxy("*errors").removeItem(a).isModelEmpty()&&ka.removeItem(this.path)}});h.addValidator=function(a){if(P(a))for(var b=0;b<a.length;b++)h.addValidator(a[b]);
else{w[a.name]=Ea(a);if(a.name&&a.error)o.errors[a.name]=a.error;y[a.name]=function(b,e,f){f.mh.push({path:e.path,modelEvents:"beforeUpdate",view:b,modelHandler:"*"+a.name,options:!0===e[a.name]?j:e[a.name]})}}};h.addValidator([{name:"required",isValid:function(){return!0}},{name:"email",isValid:F(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i)},
{name:"url",isValid:F(/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i)},
{name:"date",isValid:F(/Invalid|NaN/,!0)},{name:"dateISO",isValid:F(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/)},{name:"number",isValid:F(/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/)},{name:"digits",isValid:F(Fa)},{name:"creditcard",isValid:function(a){if(/[^0-9\-]+/.test(a))return!1;for(var b=0,d=0,e=!1,a=a.replace(/\D/g,""),f=a.length-1;0<=f;f--){d=a.charAt(f);d=parseInt(d,10);if(e&&9<(d*=2))d-=9;b+=d;e=!e}return 0===b%10}},{name:"minlength",isValid:function(a,b){return a.length>=b.minlength},buildOptions:function(a){var b;
if(a&&(b=R.exec(a)))return{minlength:+b[1],userError:b[3]};throw"invalid options for minlength validator";},buildError:G("minlength")},{name:"maxlength",isValid:function(a,b){return a.length<=b.maxlength},buildOptions:function(a){var b;if(a&&(b=R.exec(a)))return{maxlength:+b[1],userError:b[3]};throw"invalid options for maxlength validator";},buildError:G("maxlength")},{name:"rangelength",isValid:function(a,b){return a.length>=b.minlength&&a.length<=b.maxlength},buildOptions:function(a){var b;if(a&&
(b=Ga.exec(a)))return{minlength:+b[1],maxlength:+b[2],userError:b[4]};throw"invalid options for rangelength validator";},buildError:G("minlength","maxlength")},{name:"min",isValid:function(a,b){return a>=b.min},buildOptions:function(a){var b;if(a&&(b=R.exec(a)))return{min:+b[1],userError:b[3]};throw"invalid options for min validator";},buildError:G("min")},{name:"max",isValid:function(a,b){return a<=b.max},buildOptions:function(a){var b;if(a&&(b=R.exec(a)))return{max:+b[1],userError:b[3]};throw"invalid options for max validator";
},buildError:G("max")},{name:"range",isValid:function(a,b){return a>=b.min&&a<=b.max},buildOptions:function(a){var b;if(a&&(b=Ga.exec(a)))return{min:+b[1],max:+b[2],userError:b[4]};throw"invalid options for range validator";},buildError:G("min","max")},{name:"equal",isValid:function(a,b){return k.get(b.path)===a},buildOptions:function(a){var b;if(a&&(b=R.exec(a)))return{path:b[1],userError:b[3]};throw"invalid options for equal validator";}},{name:"regex",isValid:function(a,b){return b.regex.test(a)},
buildOptions:function(a){var b;if(a&&(b=bb.exec(a)))return{regex:eval(b[1]),userError:b[5]};throw"invalid options for regex validator";}}]);h.validate=function(a,b,d){return n(b)?h.addModelHandler(a,"beforeUpdate","*"+b,d):h.addModelHandler(a,"beforeUpdate",Ea(b))};h.modelCleanups.push(function(a){ka.removeItem(a)});w.inlineError=function(a){a.isModelEmpty()?f(this).removeClass("error").next("span.error").remove():f(this).addClass("error").next("span.error").remove().end().after("<span class='error'>"+
a.currentValue()+"</span>")};y.inlineError=function(a,b,d){d.mh.push({path:b.path+"*errors",modelEvents:"after*",view:a,modelHandler:"*inlineError"})};i(E,{enableQuery:function(a){var b={query:{page:{enabled:!1,index:0,count:1,size:0},sort:{by:null,asc:null},filter:{filterBuilder:function(){if(this.ops&&this.by&&this.value)return b.query.filter.defaultFilter},defaultFilter:function(){var a=b.query.filter,e=a.by,f=a.value;switch(a.ops){case "equals":return C("^"+f+"$","i").test(this[e]);case "contains":return C(f,
"i").test(this[e])}return!0},by:"",value:"",ops:"",enabled:function(){return!!this.filterBuilder()}},enabled:function(){var a=this.sort;return!!this.page.enabled||!!a.by||!!this.filter.enabled()}},queryResult:function(a){var b=f(this.mainModel()),g=this.query,i=g.filter.filterBuilder(),b=i?b.filter(i).get():b.get();h().update(this.mainPath+"*hasResult",0<b.length);g.sort.by&&b.sortObject(g.sort.by,g.sort.asc);g=g.page;if(!a&&g.enabled){a=Math.ceil(b.length/g.size)||1;if(a!=g.count){g.count=a;if(g.index>
g.count-1)g.index=0;h(this.mainPath+"*query.page").triggerChange()}b=b.slice(g.index*g.size,(g.index+1)*g.size)}return b},hasResult:!1};this.shadowProxy().create(b);h.addRef(this.context+"*queryResult",this.context);a||h.removeRef(this.context+"*queryResult",this.context+"*query");return this},notifyQueryChange:function(){return this.triggerChange("*queryResult")},enableSorter:function(){this.shadowProxy().create("sort",{by:"",asc:!0});h.addModelHandler(this.context+"*sort","after*",function(a){var b=
a.currentValue();b.by&&a.currentProxy().mainProxy().sort(b.by,b.asc)})},setPageIndex:function(a){a instanceof L&&(a=f(a.e.target).attr("page"));var b=this.get("*query.page");if(Fa.test(a))a=+a;else if("next"==a)a=b.index+1;else if("previous"==a)a=b.index-1;else if("first"==a)a=0;else if("last"==a)a=b.count-1;else if("disabled"==a)return this.update("*query.page.enabled",!1);if("number"!==typeof a||0>a||a>b.count-1)a=0;return this.update("*query.page.index",a)},disableFilter:function(){this.childProxy("*query.filter").update("by",
"").update("value","").update("ops","");return this},disablePage:function(){var a=this.get("*query.page");a.size=0;a.count=1;a.index=0;a.enabled=!1;this.triggerChange("*query.page");return this},disableSort:function(){this.childProxy("*query.sort").update("by",null).update("asc",null);return this},clearQuery:function(){return this.disablePage().disableSort().disableFilter()}});i(Q,{sortQuery:"@vh:*query.sort.by,click,*stringOptions;*query.sort.asc,click,*toggle,_;.,click,p.notifyQueryChange,_",resetQuerySort:"@mh:*query.sort.by,init|afterUpdate,*showIfTruthy ;@vh:.,click,p.clearQuery;.,click,p.notifyQueryChange",
queryPager:"@mh:*query.page,init|after*,*template;*hasResult,init|after*,*showIfTruthy,_",enablePaging:"@mh:*query.page.size,init|afterUpdate,*enableIfTruthy@vh:*query.page.enabled,click,*trueValue;.,click,p.notifyQueryChange",sortModel:"@vh:*sort.by,click,*stringOptions;*sort.asc,click,*toggle,_;.,click,"});h.editMode={none:0,create:1,update:2};h.ViewEvent.prototype.selectedIndex=function(){return f(this.e.currentTarget).children().filter(f(this.e.target).parents()).index()};i(E,{enableListEdit:function(a){return this.shadowProxy().create({edit:{mode:0,
item:null,selectedIndex:-1,newItem:a}}).popProxy()}});i(M,{newDataItem:function(a){var b;a.options?b=i({},a.options):(b=k.get(a.path+"*edit.newItem"))?b=i({},b):(b=a.targetProxy().get(0))&&(b=h.clearObj(i({},b)));if(!b)throw"can not find create a new item";a.targetProxy().update("*edit.item",b)},insertDataItem:function(a){a=a.targetProxy();a.push(a.get("*edit.item")).update("*edit.item",null).update("*edit.mode",h.editMode.none)},cancelNewDataItem:function(a){a.targetProxy().update("*edit.item",null).update("*edit.mode",
h.editMode.none)},removeItem:function(a){var b=a.targetProxy();b.childProxy("*edit").update("selectedIndex",-1).update("mode",h.editMode.none);var d=b.get("*queryResult")||b.get();b.removeItem(d[a.selectedIndex()])},updateItem:function(a){var b=a.selectedIndex(),a=a.targetProxy(),d=a.childProxy("*edit"),e=a.get("*queryResult")||a.get();a.swap(e[b],d.get("item"));d.update("item",null).update("mode",h.editMode.none).update("selectedIndex",-1)},cancelEditItem:function(a){a.selectedIndex();a.targetProxy().childProxy("*edit").update("item",
null).update("mode",h.editMode.none).update("selectedIndex",-1)},editItem:function(a){var b=a.selectedIndex(),d=a.targetProxy(),a=d.childProxy("*edit"),d=d.get("*queryResult")||d.get();a.update("item",f.extend({},d[b])).update("selectedIndex",b).update("mode",h.editMode.update)}});i(w,{renderNewItem:function(a){if(1===a.targetValue()){var b=a.targetProxy().mainProxy().get("*edit.item");f(this).renderTemplate(a.options,b,function(a){f(this).html(a);a.view()})}else f(this).empty()},renderEditItem:function(a){var b=
a.currentValue(),d=a.targetProxy().mainProxy();-1!==b&&f(this).renderTemplate(a.options,d.get("*edit.item"),function(a){f(this).children().eq(b).replaceWith(a);a.view()})},renderReadItem:function(a){if(-1===a.currentValue()){var b=a.targetProxy().mainProxy();f(this).renderTemplate(a.options,(b.get("*queryResult")||b.get())[a.removed],function(b){f(this).children().eq(a.removed).replaceWith(b);b.view()})}}});h.addViaEvent("action","click");y.editableList=function(a,b,d,e){var g=e.split(","),e=f.trim(g[0]),
h=f.trim(g[1]),g=g[2],b=b.path;d.mh.push({path:b+"*edit.selectedIndex",modelEvents:"afterUpdate",view:a,modelHandler:"*renderReadItem",options:g?e+","+g:e},{path:b+"*edit.selectedIndex",modelEvents:"afterUpdate",view:a,modelHandler:"*renderEditItem",options:g?h+","+g:h});d.vh.push({path:b,viewEvents:"action.edit",view:a,viewHandler:"*editItem"},{path:b,viewEvents:"action.remove",view:a,viewHandler:"*removeItem"},{path:b,viewEvents:"action.update",view:a,viewHandler:"*updateItem"},{path:b,viewEvents:"action.cancelEdit",
view:a,viewHandler:"*cancelEditItem"})};i(Q,{newItemButton:"@vh:.,click,*newDataItem;*edit.mode,click,*numberOptions,1;*edit.selectedIndex,*numberOptions,-1@mh:*edit.mode,init|afterUpdate,*showIfFalsy",newItemForm:"@mh:.mode,init|afterUpdate,*renderNewItem",renderEditItem:"@mh:*edit.selectedIndex,afterUpdate,*renderEditItem"});y.app=function(a,b,d,e){var g=H(f.trim(e));h.downloadApp(g).done(function(){h.getApp(g).load(a)})};k.create("*appStore",{});h.downloadApp=function(a){return h.getApp(a)?f.Deferred().resolve().promise():
matrix(H(a)+".app")};h.addApp=function(a,b){a=H(a);return h.getApp(a)?this:k.create("*appStore."+H(a),b)};h.removeApp=function(a){if(h.getApp(a))return a=H(a),matrix.release(a+".app"),k.del("*appStore."+a)};h.getApp=function(a){return k.get("*appStore."+H(a))}}(jQuery,window);
